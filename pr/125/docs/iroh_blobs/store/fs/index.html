<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="File based blob store."><title>iroh_blobs::store::fs - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../../../static.files/rustdoc-dbdb5eec.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="iroh_blobs" data-themes="" data-resource-suffix="" data-rustdoc-version="1.85.0-nightly (d10a6823f 2024-11-29)" data-channel="nightly" data-search-js="search-92e6798f.js" data-settings-js="settings-0f613d39.js" ><script src="../../../static.files/storage-59e33391.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../../static.files/main-5f194d8c.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-893ab5e7.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-044be391.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../iroh_blobs/index.html">iroh_<wbr>blobs</a><span class="version">0.91.0</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Module fs</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#file-based-blob-store" title="File based blob store.">File based blob store.</a></li><li><a href="#the-main-actor" title="The main actor">The main actor</a></li><li><a href="#the-database-actor" title="The database actor">The database actor</a></li><li><a href="#tasks" title="Tasks">Tasks</a></li><li><a href="#context" title="Context">Context</a></li><li><a href="#runtime" title="Runtime">Runtime</a></li></ul><h3><a href="#modules">Module Items</a></h3><ul class="block"><li><a href="#modules" title="Modules">Modules</a></li><li><a href="#structs" title="Structs">Structs</a></li></ul></section><div id="rustdoc-modnav"><h2><a href="../index.html">In iroh_<wbr>blobs::<wbr>store</a></h2></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><span class="rustdoc-breadcrumbs"><a href="../../index.html">iroh_blobs</a>::<wbr><a href="../index.html">store</a></span><h1>Module <span>fs</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../../src/iroh_blobs/store/fs.rs.html#1-2233">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="file-based-blob-store"><a class="doc-anchor" href="#file-based-blob-store">§</a>File based blob store.</h2>
<p>A file based blob store needs a writeable directory to work with.</p>
<p>General design:</p>
<p>The file store consists of two actors.</p>
<h2 id="the-main-actor"><a class="doc-anchor" href="#the-main-actor">§</a>The main actor</h2>
<p>The purpose of the main actor is to handle user commands and own a map of
handles for hashes that are currently being worked on.</p>
<p>It also owns tasks for ongoing import and export operations, as well as the
database actor.</p>
<p>Handling a command almost always involves either forwarding it to the
database actor or creating a hash context and spawning a task.</p>
<h2 id="the-database-actor"><a class="doc-anchor" href="#the-database-actor">§</a>The database actor</h2>
<p>The database actor is responsible for storing metadata about each hash,
as well as inlined data and outboard data for small files.</p>
<p>In addition to the metadata, the database actor also stores tags.</p>
<h2 id="tasks"><a class="doc-anchor" href="#tasks">§</a>Tasks</h2>
<p>Tasks do not return a result. They are responsible for sending an error
to the requester if possible. Otherwise, just dropping the sender will
also fail the receiver, but without a descriptive error message.</p>
<p>Tasks are usually implemented as an impl fn that does return a result,
and a wrapper (named <code>..._task</code>) that just forwards the error, if any.</p>
<p>That way you can use <code>?</code> syntax in the task implementation. The impl fns
are also easier to test.</p>
<h2 id="context"><a class="doc-anchor" href="#context">§</a>Context</h2>
<p>The main actor holds a TaskContext that is needed for almost all tasks,
such as the config and a way to interact with the database.</p>
<p>For tasks that are specific to a hash, a HashContext combines the task
context with a slot from the table of the main actor that can be used
to obtain an unique handle for the hash.</p>
<h2 id="runtime"><a class="doc-anchor" href="#runtime">§</a>Runtime</h2>
<p>The fs store owns and manages its own tokio runtime. Dropping the store
will clean up the database and shut down the runtime. However, some parts
of the persistent state won’t make it to disk, so operations involving large
partial blobs will have a large initial delay on the next startup.</p>
<p>It is also not guaranteed that all write operations will make it to disk.
The on-disk store will be in a consistent state, but might miss some writes
in the last seconds before shutdown.</p>
<p>To avoid this, you can use the <a href="../../api/struct.Store.html#method.shutdown" title="method iroh_blobs::api::Store::shutdown"><code>crate::api::Store::shutdown</code></a> method to
cleanly shut down the store and save ephemeral state to disk.</p>
<p>Note that if you use the store inside a [<code>iroh::protocol::Router</code>] and shut
down the router using [<code>iroh::protocol::Router::shutdown</code>], the store will be
safely shut down as well. Any store refs you are holding will be inoperable
after this.</p>
</div></details><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="options/index.html" title="mod iroh_blobs::store::fs::options">options</a></div><div class="desc docblock-short">Options for configuring the file store.</div></li></ul><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.FsStore.html" title="struct iroh_blobs::store::fs::FsStore">FsStore</a></div><div class="desc docblock-short">A file based store.</div></li></ul></section></div></main></body></html>